name: Continuous Integration & Deployment

on:
  push:
    branches:
      - "main"
      - "dev"
      - "test"
    paths-ignore:
      - "**.md"
      - ".github/**"

jobs:
  cicd:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write  # Required for OIDC authentication if used

    steps:
      - name: "setup:checkout-code"
        uses: actions/checkout@v4

      - name: "setup:set-environment"
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
          else
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          fi

      - name: "setup:configure-aws-credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::748026688964:role/GitHubActionsAWSRole
          aws-region: eu-west-1

      - name: "setup:login-ecr"
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: "setup:set-deployment-strategy"
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "DEPLOYMENT_STRATEGY=canary" >> $GITHUB_ENV
          else
            echo "DEPLOYMENT_STRATEGY=rolling" >> $GITHUB_ENV
          fi

      - name: "build:build-and-push"
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          GIT_REPOSITORY=$(echo "${{ github.repository }}" | cut -d'/' -f2)

          echo "GIT_REPOSITORY=$GIT_REPOSITORY" >> $GITHUB_ENV

          ECR_REPOSITORY="$ENVIRONMENT-$GIT_REPOSITORY" >> $GITHUB_ENV

          IMAGE_TAG="${{ github.ref_name }}-${COMMIT_SHA::7}"
          IMAGE_TAG_LATEST="latest"

          echo "Building Docker image..."
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG .

          echo "Tagging image as latest..."
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG_LATEST

          echo "Pushing images to ECR..."
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG_LATEST

      - name: build:register-ecs-task-definition
        run: |
          IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:latest"
          
          aws ecs describe-task-definition \
            --task-definition $GIT_REPOSITORY-$ENVIRONMENT-task-definition \
            --region $AWS_REGION \
            --query 'taskDefinition' \
            --output json \
          | jq '{
              family,
              networkMode,
              containerDefinitions,
              volumes,
              taskRoleArn,
              executionRoleArn,
              requiresCompatibilities,
              cpu,
              memory
            }' > ecs-task-def-updated.json

          sed -i "s|<IMAGE>|$IMAGE|g" ecs-task-def-updated.json
          TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json file://ecs-task-def-updated.json \
                          | jq -r '.taskDefinition.taskDefinitionArn')
          echo "TASK_DEF_ARN=$TASK_DEF_ARN" >> $GITHUB_ENV

      - name: "deploy:deploy-ecs-service"
        run: |
          CLUSTER_NAME="$ENVIRONMENT-ecs-cluster"
          SERVICE_NAME="$GIT_REPOSITORY-$ENVIRONMENT-service"
          TASK_DEF_ARN="$TASK_DEF_ARN"

          if [[ "${DEPLOYMENT_STRATEGY}" == "canary" ]]; then
            echo "Triggering CodeDeploy ECS canary deployment..."

              # Generate appspec.json correctly (EOF at column 0)
            cat > appspec.json <<EOF
          {
            "version": "0.0",
            "Resources": [
              {
                "TargetService": {
                  "Type": "AWS::ECS::Service",
                  "Properties": {
                    "TaskDefinition": "$TASK_DEF_ARN",
                    "LoadBalancerInfo": {
                      "ContainerName": "app",
                      "ContainerPort": 8080
                    }
                  }
                }
              }
            ]
          }
          EOF

            # Validate JSON
            jq . appspec.json > /dev/null

            APPSPEC=$(jq -c . appspec.json)

            aws deploy create-deployment \
              --application-name $GIT_REPOSITORY-$ENVIRONMENT-codedeploy \
              --deployment-group-name $GIT_REPOSITORY-$ENVIRONMENT-canary \
              --deployment-config-name CodeDeployDefault.ECSCanary10Percent5Minutes \
              --description "Canary deployment triggered by GHA" \
              --revision revisionType=AppSpecContent,appSpecContent=$APPSPEC

            echo "CodeDeploy canary deployment triggered successfully."

          else
            echo "Performing standard ECS rolling update..."

            # Update ECS service with new task definition (rolling update)
            aws ecs update-service \
              --cluster $CLUSTER_NAME \
              --service $SERVICE_NAME \
              --task-definition $TASK_DEF_ARN \
              --force-new-deployment \
              --region $AWS_REGION

            # Wait until service stabilizes
            aws ecs wait services-stable \
              --cluster $CLUSTER_NAME \
              --services $SERVICE_NAME \
              --region $AWS_REGION
          fi
